<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Creator_Kristina.ai ‚Äî Mini App</title>
  <style>
    :root { --bg:#0b0f14; --card:#121826; --muted:#94a3b8; --txt:#e5e7eb; --accent:#7c3aed; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--txt); }
    header{ padding:16px; background:linear-gradient(135deg,#111827,#0b0f14); position:sticky; top:0; border-bottom:1px solid #1f2937;}
    h1{ font-size:16px; margin:0; }
    .wrap{ padding:16px; max-width:720px; margin:0 auto; }
    .tabs{ display:flex; gap:8px; margin:12px 0 16px; }
    .tab{ flex:1; padding:10px 12px; border:1px solid #1f2937; background:var(--card); color:var(--txt); border-radius:12px; cursor:pointer; }
    .tab.active{ border-color:var(--accent); box-shadow:0 0 0 2px rgba(124,58,237,.25) inset; }
    .card{ background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:14px; margin:12px 0; }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    textarea,input{ width:100%; background:#0b1220; color:var(--txt); border:1px solid #22304a; border-radius:12px; padding:10px 12px; outline:none; }
    textarea{ min-height:110px; resize:vertical; }
    .row{ display:flex; gap:10px; }
    .row > div{ flex:1; }
    .btn{ width:100%; padding:12px; border:0; border-radius:12px; background:var(--accent); color:white; font-weight:700; cursor:pointer; }
    .btn.secondary{ background:#1f2937; }
    .muted{ color:var(--muted); font-size:12px; }
    .out{ white-space:pre-wrap; line-height:1.35; }
    a{ color:#a78bfa; }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<header>
  <h1>Creator_Kristina.ai ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (ApiFree)</h1>
  <div class="muted" id="balance">–ë–∞–ª–∞–Ω—Å: ‚Ä¶</div>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="tab active" data-tab="chat">üí¨ Chat</button>
    <button class="tab" data-tab="image">üñº –§–æ—Ç–æ</button>
    <button class="tab" data-tab="video">üé¨ –í–∏–¥–µ–æ</button>
    <button class="tab" data-tab="ref">üéÅ –†–µ—Ñ–µ—Ä–∞–ª–∫–∞</button>
  </div>

  <div class="card" id="panel-chat">
    <label>–¢–µ–∫—Å—Ç –¥–ª—è ChatGPT</label>
    <textarea id="chatText" placeholder="–ù–∞–ø–∏—à–∏ –∑–∞–ø—Ä–æ—Å..."></textarea>
    <button class="btn" id="chatGo">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <div class="card out" id="chatOut" style="display:none"></div>
  </div>

  <div class="card" id="panel-image" style="display:none">
    <label>–ü—Ä–æ–º–ø—Ç –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
    <textarea id="imgPrompt" placeholder="–û–ø–∏—à–∏, —á—Ç–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å..."></textarea>
    <button class="btn" id="imgGo">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
    <div class="muted" id="imgStatus"></div>
    <div class="card out" id="imgOut" style="display:none"></div>
  </div>

  <div class="card" id="panel-video" style="display:none">
    <label>–ü—Ä–æ–º–ø—Ç –¥–ª—è –≤–∏–¥–µ–æ</label>
    <textarea id="vidPrompt" placeholder="–û–ø–∏—à–∏ –≤–∏–¥–µ–æ..."></textarea>
    <div class="row">
      <div><label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–µ–∫)</label><input id="vidDuration" type="number" min="1" value="5"/></div>
      <div><label>FPS</label><input id="vidFps" type="number" min="1" value="24"/></div>
    </div>
    <button class="btn" id="vidGo">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
    <div class="muted" id="vidStatus"></div>
    <div class="card out" id="vidOut" style="display:none"></div>
  </div>

  <div class="card" id="panel-ref" style="display:none">
    <div class="muted">–ü–æ–¥–µ–ª–∏—Å—å —Å—Å—ã–ª–∫–æ–π ‚Äî –ø–æ–ª—É—á–∏—à—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.</div>
    <div class="card" style="margin-top:10px">
      <div class="muted">–¢–≤–æ—è —Å—Å—ã–ª–∫–∞:</div>
      <div id="refLink" style="word-break:break-all"></div>
      <div style="height:10px"></div>
      <button class="btn" id="shareBtn">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
      <div style="height:8px"></div>
      <button class="btn secondary" id="copyBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
  </div>
</div>

<script>
const tg = window.Telegram?.WebApp;
tg?.ready();

function $(id){ return document.getElementById(id); }

const state = { tg_id: null, bot_username: null };

function setTab(name){
  for (const el of document.querySelectorAll('.tab')) el.classList.toggle('active', el.dataset.tab===name);
  for (const p of ['chat','image','video','ref']) $('panel-'+p).style.display = (p===name?'block':'none');
}

document.querySelectorAll('.tab').forEach(btn => btn.onclick = () => setTab(btn.dataset.tab));

async function api(path, opts){
  const r = await fetch(path, opts);
  const data = await r.json().catch(()=>({}));
  if (!r.ok) throw new Error(data.detail || data.error || ('HTTP '+r.status));
  return data;
}

async function loadMe(){
  // In real production you should verify initData on backend.
  // For MVP we just use tg.initDataUnsafe.user.id
  state.tg_id = tg?.initDataUnsafe?.user?.id || null;
  state.bot_username = tg?.initDataUnsafe?.user?.username || null;

  if (!state.tg_id){
    $('balance').innerText = '–û—Ç–∫—Ä–æ–π –≤–Ω—É—Ç—Ä–∏ Telegram';
    return;
  }
  const me = await api('/api/me?tg_id='+state.tg_id);
  $('balance').innerText = `–ë–∞–ª–∞–Ω—Å: Free ${me.credits_free} ‚Ä¢ PRO ${me.credits_pro}`;
  // referral link
  const bot = tg?.initDataUnsafe?.chat?.username || '';
  const ref = `https://t.me/${bot || 'YOUR_BOT'}?start=ref_${state.tg_id}`;
  $('refLink').innerText = ref;
  state.refLink = ref;
}

$('chatGo').onclick = async () => {
  $('chatOut').style.display='none';
  try{
    const text = $('chatText').value.trim();
    const data = await api('/api/chat', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({tg_id: state.tg_id, text})});
    $('chatOut').innerText = data.answer;
    $('chatOut').style.display='block';
    await loadMe();
  }catch(e){ alert(e.message); }
};

$('imgGo').onclick = async () => {
  $('imgOut').style.display='none';
  $('imgStatus').innerText = '–û—Ç–ø—Ä–∞–≤–ª—è—é...';
  try{
    const prompt = $('imgPrompt').value.trim();
    const res = await api('/api/image/submit', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({tg_id: state.tg_id, prompt})});
    const request_id = res.apifree.request_id;
    $('imgStatus').innerText = '–í –æ—á–µ—Ä–µ–¥–∏: '+request_id+' (–∂–¥—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç...)';
    // poll
    for (let i=0;i<30;i++){
      await new Promise(r=>setTimeout(r, 2000));
      const out = await api('/api/image/result/'+request_id);
      const st = out.apifree.status;
      if (st === 'completed'){
        const url = out.apifree.images?.[0]?.url;
        $('imgOut').innerHTML = url ? `<a href="${url}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É</a>` : JSON.stringify(out.apifree,null,2);
        $('imgOut').style.display='block';
        $('imgStatus').innerText = '–ì–æ—Ç–æ–≤–æ ‚úÖ';
        break;
      } else {
        $('imgStatus').innerText = '–°—Ç–∞—Ç—É—Å: '+st+'...';
      }
    }
    await loadMe();
  }catch(e){ $('imgStatus').innerText='–û—à–∏–±–∫–∞'; alert(e.message); }
};

$('vidGo').onclick = async () => {
  $('vidOut').style.display='none';
  $('vidStatus').innerText = '–û—Ç–ø—Ä–∞–≤–ª—è—é...';
  try{
    const prompt = $('vidPrompt').value.trim();
    const duration = parseInt($('vidDuration').value || '5');
    const fps = parseInt($('vidFps').value || '24');
    const res = await api('/api/video/submit', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({tg_id: state.tg_id, prompt, duration, fps})});
    const request_id = res.apifree.request_id;
    $('vidStatus').innerText = '–í –æ—á–µ—Ä–µ–¥–∏: '+request_id+' (–∂–¥—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç...)';
    for (let i=0;i<60;i++){
      await new Promise(r=>setTimeout(r, 3000));
      const out = await api('/api/video/result/'+request_id);
      const st = out.apifree.status;
      if (st === 'completed'){
        const url = out.apifree.videos?.[0]?.url || out.apifree.url;
        $('vidOut').innerHTML = url ? `<a href="${url}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ</a>` : JSON.stringify(out.apifree,null,2);
        $('vidOut').style.display='block';
        $('vidStatus').innerText = '–ì–æ—Ç–æ–≤–æ ‚úÖ';
        break;
      } else {
        $('vidStatus').innerText = '–°—Ç–∞—Ç—É—Å: '+st+'...';
      }
    }
    await loadMe();
  }catch(e){ $('vidStatus').innerText='–û—à–∏–±–∫–∞'; alert(e.message); }
};

$('shareBtn').onclick = () => {
  if (!tg){ alert('–û—Ç–∫—Ä–æ–π –≤–Ω—É—Ç—Ä–∏ Telegram'); return; }
  tg.shareUrl(state.refLink, 'üéÅ –ü–æ–ª—É—á–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤ Creator_Kristina.ai');
};

$('copyBtn').onclick = async () => {
  try{ await navigator.clipboard.writeText(state.refLink); alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); }
  catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'); }
};

loadMe().catch(e => console.error(e));
</script>
</body>
</html>
